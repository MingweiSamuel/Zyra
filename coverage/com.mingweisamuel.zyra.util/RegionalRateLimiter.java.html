<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegionalRateLimiter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">zyra</a> &gt; <a href="index.source.html" class="el_package">com.mingweisamuel.zyra.util</a> &gt; <span class="el_source">RegionalRateLimiter.java</span></div><h1>RegionalRateLimiter.java</h1><pre class="source lang-java linenums">package com.mingweisamuel.zyra.util;

import com.mingweisamuel.zyra.RiotApiConfig;
import org.asynchttpclient.Response;

import java.util.Arrays;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.TimeUnit;
import java.util.function.Supplier;

/**
 * Represents rate limits for a particular region.
 */
public class RegionalRateLimiter {

    /** Configuration information. */
    private final RiotApiConfig config;

    /** Represents the app rate limit. */
    private final TokenRateLimit applicationRateLimit;
    /** Represents method rate limits. */
<span class="fc" id="L24">    private final ConcurrentMap&lt;String, TokenRateLimit&gt; methodRateLimits = new ConcurrentHashMap&lt;&gt;();</span>

<span class="fc" id="L26">    public RegionalRateLimiter(RiotApiConfig config) {</span>
<span class="fc" id="L27">        this.config = config;</span>
<span class="fc" id="L28">        this.applicationRateLimit = new TokenRateLimit(TokenRateLimit.RateLimitType.APPLICATION, config);</span>
<span class="fc" id="L29">    }</span>

    public CompletableFuture&lt;Response&gt; getMethodRateLimited(final String methodId,
        final Supplier&lt;CompletableFuture&lt;Response&gt;&gt; supplier) {

<span class="fc" id="L34">        final TokenRateLimit methodRateLimit = getMethodRateLimit(methodId);</span>

<span class="fc" id="L36">        RateLimitRetrierRunnable runnable = new RateLimitRetrierRunnable(supplier, methodRateLimit);</span>
<span class="fc" id="L37">        runnable.run();</span>
<span class="fc" id="L38">        return runnable.completion;</span>
    }

    public CompletableFuture&lt;Response&gt; getRateLimited(final String methodId,
        final Supplier&lt;CompletableFuture&lt;Response&gt;&gt; supplier) {

<span class="fc" id="L44">        final TokenRateLimit methodRateLimit = getMethodRateLimit(methodId);</span>

<span class="fc" id="L46">        RateLimitRetrierRunnable runnable = new RateLimitRetrierRunnable(supplier, applicationRateLimit, methodRateLimit);</span>
<span class="fc" id="L47">        runnable.run();</span>
<span class="fc" id="L48">        return runnable.completion;</span>
    }

    private TokenRateLimit getMethodRateLimit(String methodId) {
<span class="fc" id="L52">        return methodRateLimits.computeIfAbsent(methodId, id -&gt; new TokenRateLimit(</span>
            TokenRateLimit.RateLimitType.METHOD, config));
    }

    /**
     * HTTP status codes that are considered a &quot;success&quot; in the sense that we did not violate limits
     * and the Riot API did its job without failing. The 20x will be deserialized, wile the 404 and 422
     * will return null.
     *
     * HTTP status codes that are retry-able: 400 (sometimes returned, ?), 429 (with valid retry headers), and
     * all 5xx responses.
     *
     * Other responses will throw a {@link RiotResponseException}.
     */
<span class="fc" id="L66">    private static final int[] RESPONSE_STATUS_SUCCESS = { 200, 204, 404, 422 };</span>

    /**
     * A runnable to wait for rate limits before sending requests and getting responses.
     */
    private class RateLimitRetrierRunnable implements Runnable {

        /** Supplies response asynchronously. */
        private final Supplier&lt;CompletableFuture&lt;Response&gt;&gt; supplier;
        /** Rate limits to obey. */
        private final RateLimit[] rateLimits;

        /** The number of retries. (The first try is 0 retries). */
<span class="fc" id="L79">        private volatile int retries = 0;</span>

        /** Future the response is passed to. */
<span class="fc" id="L82">        final CompletableFuture&lt;Response&gt; completion = new CompletableFuture&lt;&gt;();</span>

<span class="fc" id="L84">        RateLimitRetrierRunnable(Supplier&lt;CompletableFuture&lt;Response&gt;&gt; supplier, RateLimit... rateLimits) {</span>
<span class="fc" id="L85">            this.supplier = supplier;</span>
<span class="fc" id="L86">            this.rateLimits = rateLimits;</span>
<span class="fc" id="L87">        }</span>

        @Override
        public void run() {
            long delay;
<span class="fc bfc" id="L92" title="All 2 branches covered.">            if ((delay = RateLimit.getOrDelay(rateLimits)) &lt; 0) { // Success.</span>
<span class="fc" id="L93">                supplier.get()</span>
<span class="fc" id="L94">                    .thenAccept(r -&gt; {</span>
<span class="fc" id="L95">                        int status = r.getStatusCode();</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">                        boolean success = 0 &lt;= Arrays.binarySearch(RESPONSE_STATUS_SUCCESS, status);</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">                        if (config.responseListener != null)</span>
<span class="nc" id="L98">                            config.responseListener.onResponse(success, r);</span>

<span class="fc bfc" id="L100" title="All 2 branches covered.">                        for (RateLimit rateLimit : rateLimits)</span>
                            // If there is a 429 with invalid headers, the rate limiter will throw a RiotResponseException.
<span class="fc" id="L102">                            rateLimit.onResponse(r);</span>

<span class="pc bpc" id="L104" title="1 of 2 branches missed.">                        if (success) { // Success.</span>
<span class="fc" id="L105">                            completion.complete(r);</span>
<span class="fc" id="L106">                            return;</span>
                        }
<span class="nc bnc" id="L108" title="All 6 branches missed.">                        if (retries &gt;= config.retries ||</span>
                                // Ignore if status can be retried. 400 is iffy.
                                (/*status != 400 &amp;&amp;*/ status != 429 &amp;&amp; status &lt; 500)) {

<span class="nc" id="L112">                            throw new RiotResponseException(String.format(&quot;Request failed after %d retries (%d).&quot;,</span>
<span class="nc" id="L113">                                retries, r.getStatusCode()), r);</span>
                        }
                        // Retry.
<span class="nc" id="L116">                        retries++; // Should be fine to not be synchronized, only one thread in this section.</span>
<span class="nc" id="L117">                        RateLimitedRequester.executor.get().schedule(this, delay, TimeUnit.MILLISECONDS);</span>
<span class="pc" id="L118">                    }).exceptionally(e -&gt; {</span>
<span class="nc" id="L119">                        completion.completeExceptionally(e);</span>
<span class="nc" id="L120">                        return null;</span>
                    });
<span class="fc" id="L122">                return;</span>
            }
<span class="fc" id="L124">            RateLimitedRequester.executor.get().schedule(this, delay, TimeUnit.MILLISECONDS);</span>
<span class="fc" id="L125">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>